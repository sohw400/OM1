#!/usr/bin/env node

import { spawn } from 'child_process';
import { fileURLToPath } from 'url';
import { dirname, join } from 'path';
import { existsSync } from 'fs';

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);
const projectRoot = join(__dirname, '..');
const nodeModulesPath = join(projectRoot, 'node_modules');
const packageJsonPath = join(projectRoot, 'package.json');

// Function to run a command and return a promise
function runCommand(command, args, options = {}) {
  return new Promise((resolve, reject) => {
    const child = spawn(command, args, {
      stdio: 'inherit',
      cwd: projectRoot,
      ...options
    });
    
    child.on('exit', (code) => {
      if (code === 0) {
        resolve();
      } else {
        reject(new Error(`Command failed with exit code ${code}`));
      }
    });
    
    child.on('error', reject);
  });
}

// Function to check if command exists in PATH
function commandExists(command) {
  return new Promise((resolve) => {
    const child = spawn('which', [command], { stdio: 'ignore' });
    child.on('exit', (code) => resolve(code === 0));
    child.on('error', () => resolve(false));
  });
}

async function main() {
  try {
    // Check if we're in the project directory or running globally
    const isInProjectDir = existsSync(packageJsonPath);
    
    if (isInProjectDir) {
      // Running from project directory - handle setup if needed
      const needsSetup = !existsSync(nodeModulesPath);
      const isLinked = await commandExists('openmind');
      
      if (needsSetup) {
        console.log('ğŸ“¦ Installing dependencies...');
        await runCommand('npm', ['install']);
      }
      
      if (!isLinked) {
        console.log('ğŸ”— Linking package globally...');
        await runCommand('npm', ['link']);
        console.log('âœ… Setup complete! You can now run "openmind" from anywhere.');
        
        // After linking, restart the command globally
        console.log('ğŸ”„ Restarting with global command...');
        await runCommand('openmind', []);
        return;
      }
      
      // Run the CLI from project directory
      const cliPath = join(__dirname, '..', 'src', 'cli.tsx');
      await runCommand('npx', ['tsx', cliPath]);
    } else {
      // Running globally - find the linked package and run it
      const cliPath = join(__dirname, '..', 'src', 'cli.tsx');
      await runCommand('npx', ['tsx', cliPath]);
    }
    
  } catch (error) {
    console.error('âŒ Error:', error.message);
    process.exit(1);
  }
}

main(); 